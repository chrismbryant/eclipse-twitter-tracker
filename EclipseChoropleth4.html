<!DOCTYPE html>

<!-- ***** See: https://youtu.be/suNs5p0IxWk ***** -->

<html>
  <style>

    * {
        font-family: 
            "Myriad Pro Light", "Oswald", Helvetica, sans-serif;
        margin: 0;
        padding: 0;
    }

    div #header {
        background-color: lightgray;
        padding: 1.5% 0;
    }

    div #footer {
        background-color: lightgray;
        padding: 1% 0;
    }

    
    .button:hover {
        fill-opacity: 0.4;
    }

    .centered {
        text-align: center;
    }

    h1 {
        font-size: 250%;
        font-weight: normal;
    }

    p {
        position: auto;
        font-size: 120%;
        display: inline;
    }

    svg {
        display: block;
        margin: 0 auto;
    }

  </style>
  <head>
    <meta charset="utf-8">
    <title>Eclipse Twitter Tracker Choropleth</title>

    <!-- bulma css-->
    <!-- <link rel="stylesheet"  type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.3.2/css/bulma.min.css"> -->

    <!-- D3.js CDN source -->
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>

  </head>
  <body>
    <div class="container">
        <!-- Title -->
        <div id="header">
          <h1 class="title centered">The Great American Eclipse on Twitter: August 21, 2017</h1>
        </div>
        <div id="image">
            <svg> 
                <filter id="blur">
                  <feGaussianBlur stdDeviation="5"></feGaussianBlur>
                </filter>
                <!-- the D3 code below puts stuff in here -->
            </svg>
        </div>

        <!-- Info -->
        <div id="footer">
            <p><b>Created by:</b> <a href="https://github.com/chrismbryant">Christopher M. Bryant</a>, 2017</br></p>
            <p><i>(with data collected from <a href="https://dev.twitter.com/streaming/overview" target="_blank">Twitter's Streaming API</a>, <a href="https://eclipse.gsfc.nasa.gov/SEpath/SEpath2001/SE2017Aug21Tpath.html" target="_blank">NASA</a>, and the <a href="https://www.census.gov/data/developers/data-sets/popest-popproj/popest.html" target="_blank">US Census Bureau</a>)</i></p>
        </div>
        <!-- D3 code -->
        <script>

        var svg = d3.select("svg"),
            
            
            // height = 0.4 * window.screen.availHeight,
            // width = 0.4 * window.screen.availWidth,

            width = 1152,  // 1152
            height = 600,  // 600

            zoom_low = 1,   // lowest zoom magnification
            zoom_high = 20; // highest zoom magnification

        svg.attr("class", "mysvg")
            .attr("width", width)
            .attr("height", height)
            .attr("fill", "none")
            .attr("stroke", "none")

        // defining variables for color-scaling
        var low_color = "rgb(200, 211, 234)",    // color for lowest tweet fraction
            high_color = "rgb(8,48,107)",      // color for highest tweet fraction
            low_pop_color = "white",           // color for lowest population density
            high_pop_color = "rgb(130,0,0)",   // color for highest population density
            border_color = "rgb(240,240,240)", // color for county borders
            c_num = 2,                         // no. of std devs to span with color
            color_domain = [-c_num, c_num];    // min and max color mapping value
        
        // defining button state variables for layer toggling
        var shadow_button 
            = blue_button
            = red_button
            = tweet_button
            = false;

        var pop_color = d3.scaleLinear()
            .domain(color_domain)
            .range([low_pop_color, high_pop_color]);

        var county_color = d3.scaleLinear()
            .domain(color_domain)
            .range([low_color, high_color]);
        
        // eclipseData
        var eclipseData = d3.map();

        // Loading and callback function structure essentially copied from: https://github.com/kthotav/D3Visualizations/blob/master/New_York_Income_vs_Poverty/js/ny.js

        // load TopoJSON, GeoJSON, and color data file asynchronously
        d3.queue()
            .defer(d3.json, "https://d3js.org/us-10m.v1.json")
            .defer(d3.json, "https://raw.githubusercontent.com/chrismbryant/eclipse-twitter-tracker/master/Resources/tweetGeoJSON.json")
            .defer(d3.json, "https://raw.githubusercontent.com/chrismbryant/eclipse-twitter-tracker/master/Resources/eclipseGeoJSON.json")
            .defer(d3.csv, "https://raw.githubusercontent.com/chrismbryant/eclipse-twitter-tracker/master/Resources/countycolordata.csv", function(d) {
                if (isNaN(d.Value)) {
                    eclipseData.set(d.CountyCode, 
                        [d.CountyCode, +d.Tally, +d.Population, d.Geoname, NaN]); 
                } else {
                    eclipseData.set(d.CountyCode, 
                        [d.CountyCode, +d.Tally, +d.Population, d.Geoname, +d.Value]); 
                }
            })
            .await(ready);

        // callback function  
        function ready(error, topoData, tweetGeoJSON, eclipseGeoJSON) {

            if (error) throw error;

            // Load US county TopoJSON (already encoded with Albers projection)
            var us_counties = topojson.feature(topoData, {
                type: "GeometryCollection",
                geometries: topoData.objects.counties.geometries
            });

            // Load tweet GeoJSON
            var tweets = {
                "type": tweetGeoJSON.type,
                "features": tweetGeoJSON.features
            };

            var eclipse = {
                "type": eclipseGeoJSON.type,
                "features": eclipseGeoJSON.features
            }


            // Set map projection for geography. Here, the projection is set to "null",
            // since our TopoJSON file already the Albers projection encoded into it (?).
            var geoPath = d3.geoPath()
                .projection(null)

            // Use the USA Albers projection to map the GeoJSON tweet data
            var proj = d3.geoAlbersUsa()
                // .translate([width/2, height/2])
                .scale(1280) // [HOW DO WE KNOW WHAT THIS NUMBER IS? I JUST GUESSED.]
                .translate(
                    [width*5/12, // width * 5/12
                    height/2]);  // height/2

            var tweetPath = d3.geoPath()
                .projection(proj);

            var eclipsePath = d3.geoPath()
                .projection(proj);
            
            // --------------------------- SVG BACKGROUND --------------------------- //

                var borderPath = svg.append("rect")
                    .attr("class", "background")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("height", height)
                    .attr("width", width)
                    .attr("fill", "white")
                    .attr("pointer-events", "all")

            var g = svg.append("g") // Group all the map stuff together
                .attr("class", "map")

            // ------------------------------- NATION ------------------------------- //
                // From: https://bl.ocks.org/mbostock/4136647

                // Add a soft shadow around the nation border
                var gnation = g.append("g");
                
                gnation.attr("class", "nation")
                    .append("path")
                    .attr("class", "nation-haze")
                    .datum(topojson.mesh(topoData, topoData.objects.nation))
                    .attr("d", geoPath)
                    .attr("xlink:href", "#nation")
                    .attr("fill", "black")
                    .attr("fill-opacity", 0.4)
                    .attr("filter", "url(#blur)");

                gnation.append("path")
                    .attr("class", "nation-background")
                    .datum(topojson.mesh(topoData, topoData.objects.nation))
                    .attr("d", geoPath)
                    .attr("fill", "black");

            // ---------------------- COUNTY POPULATION DENSITY --------------------- //

                // Dictionary and list of county population densities

                var getDensity = () => {
                    var density = {};
                    for (var i in us_counties.features) {
                        var county = eclipseData.get(us_counties.features[i].id)[0],
                            area = geoPath.area(us_counties.features[i]),
                            pop = eclipseData["$" + county][2];
                        density[county] = area/pop;
                    }
                    return density; 
                }

                var dict2val = (dictionary) => {
                    var val_list = [];
                    for (var key in dictionary) {
                        val_list.push(dictionary[key]);
                    }
                    return val_list;
                }
                
                density = getDensity();
                density_list = dict2val(density);            
                
                // Define a bunch of math functions for arrays.

                    var sum = (mylist) => {
                        s = 0;
                        for (var i in mylist) {s += mylist[i]}
                        return s;
                    }

                    var pow = (mylist, exp) => {
                        p = [];
                        for (var i in mylist) {p.push(Math.pow(mylist[i],exp))}
                        return p;
                    }

                    var add = (mylist, addend) => {
                        a = [];
                        for (var i in mylist) {a.push(mylist[i] + addend)}
                        return a;
                    }

                    var prod = (mylist, factor) => {
                        p = [];
                        for (var i in mylist) {p.push(mylist[i] * addend)}
                        return p;
                    }
                    
                    var mean = (mylist) => {
                        return mu = sum(mylist) / mylist.length;
                    }

                    var std = (mylist) => {
                        var s = sum(pow(add(mylist,-mean(mylist)), 2));
                        return sigma = Math.pow(s/mylist.length, 0.5);
                    }

                    var logremove = (mylist) => {
                        l = [];
                        for (var i in mylist) {
                            if (mylist[i]) {
                                l.push(Math.log(mylist[i]));
                            }
                        }
                        return l;
                    }

                // Calculate mean and std of density info for proper color mapping
                density_list = logremove(density_list);
                mu = mean(density_list);
                sigma = std(density_list);

                // Recalculate density with normalized and scaled values
                renormdensity = {}
                for (var key in density) {
                    if (Math.log(density[key]) > -1E9) {
                        renormdensity[key] = -(Math.log(density[key]) - mu) / sigma;
                        // [I CAN'T FIGURE OUT WHY I HAD TO MAKE IT NEGATIVE........] 
                    }
                }

                // US counties red population layer
                g.append("g")
                    .attr("class", "county-pop")
                    .selectAll("path")
                    .data(us_counties.features)
                    .enter()
                    .append("path")
                        .attr("class", "county-pop-path")
                        .attr("d", geoPath)
                        .attr("stroke", border_color)
                        .attr("stroke-width", 0.2)
                        .attr("fill", function(d) {
                            var county = eclipseData.get(d.id)[0];
                            return (county ? pop_color(renormdensity[county]) : low_pop_color);
                        });

            // -------------------------- COUNTY TWEET DATA ------------------------- //

                // US counties border and fill (fill is bound to eclipse data)
                var max_fill_opacity = 1;
                g.append("g")
                    .attr("class", "counties")
                    .selectAll("path")                // returns an array of <path>...</path> elements in g
                    .data(us_counties.features)       // assigns keys (bind data to array)
                    .enter()                          // for each row in data...
                    .append("path")                   // create new <path>...</path> elements
                        .attr("class", "county-tweet-path") // assigns class attribute "county-path" to each <path> element
                        .attr("d", geoPath)           // assigns attribute d to each <path> element
                        .attr("stroke", border_color)
                        .attr("stroke-width", 0.05)
                        .attr("stroke-linejoin", "round")
                        .attr("fill-opacity", max_fill_opacity)
                        // .on("click", clicked)
                        
                        .attr("fill", function(d) {
                            var Value = eclipseData.get(d.id)[4];
                            return (Value ? county_color(Value) : low_color);
                        })

                        .on("mouseover", function(d) {
                            d3.select(this).transition()
                                .duration(25)
                                .attr("fill-opacity", 0)
                        })

                        .on("mouseout", function(d){
                            d3.select(this).transition()
                                .ease(d3.easeQuadInOut)
                                .duration(400)
                                .attr("fill-opacity", max_fill_opacity)
                        })

                    // us_counties title (label counties with tweet data)
                    .append("title")
                        .text(function(d) {
                            return d.id = eclipseData.get(d.id)[3] + "\n"
                                + "# of Tweets: " + eclipseData.get(d.id)[1] + "\n"
                                + "Population: " + eclipseData.get(d.id)[2];
                        });
                    
            // ------------------------------- STATES ------------------------------- //

                // US states border
                g.append("g")
                    .attr("class", "states")
                    .append("path")
                    .attr("class", "state-path")
                    .datum(topojson.mesh(topoData, topoData.objects.states))
                    .attr("d", geoPath)
                    .attr("stroke", "white")
                    .attr("stroke-width", 1);

            // ---------------------------- ECLIPSE PATH ---------------------------- //
                // Data retrieved from: https://eclipse.gsfc.nasa.gov/SEpath/SEpath2001/SE2017Aug21Tpath.html

                // Eclipse path
                var center_opacity = 1,
                    shadow_opacity = 0.2 * center_opacity;

                var gg = g.append("g")
                    gg.attr("class", "eclipse-path")
                    .attr("pointer-events", "none") // Makes the layer intangible

                    .append("g")
                        .attr("class", "center-line")
                        .append("path")
                        .attr("class", "shadow")
                        .datum(eclipse.features[0])
                        .attr("d", eclipsePath)
                        .attr("stroke", "black")
                        .attr("stroke-width", 1)
                        .attr("stroke-opacity", center_opacity); // 0.4

                    gg.append("g")
                        .attr("class", "totality-band")
                        .append("path")
                        .attr("class", "shadow")
                        .datum(eclipse.features[1])
                        .attr("d", eclipsePath)
                        .attr("fill", "black")
                        .attr("fill-opacity", shadow_opacity);

                shadowClick(); // default eclipse path layer to OFF

            // ------------------------------- TWEETS ------------------------------- //
                
                // Draw a dot at each tweet location

                var point_radius = 1 // 1
                var point_opacity = 0.6 // 0.6

                g.append("g")
                    
                    .attr("class", "tweet-points")
                    .selectAll("tweet-points")
                    .data(tweets.features)
                    .enter()

                    .append("a")
                        .attr("href", function(d, i){
                            var content = tweets.features[i].properties;
                            return "https://twitter.com/search?l=&q=eclipse%2C%20OR%20sun%20from%3A" + 
                                content.User + "%20since%3A2017-08-21%20until%3A2017-08-22&src=typd&lang=en";
                        })
                        .attr("target", "_blank")

                    .append("path")
                    .attr("class", "tweets")
                    .attr("d", tweetPath.pointRadius(point_radius))
                    .attr("fill", "rgb(0, 172, 237)")
                    .attr("fill-opacity", point_opacity)

                    .on("mouseover", function(d) {
                        d3.select(this).transition()
                            .ease(d3.easeQuadInOut)
                            .duration(25)
                            .attr("fill-opacity", 1)
                            .attr("stroke", "white")
                            .attr("stroke-width", 1)
                            .attr("d", tweetPath.pointRadius(3 * point_radius))
                    })

                    .on("mouseout", function(d){
                        d3.select(this).transition()
                            .ease(d3.easeQuadInOut)
                            .duration(100)
                            .attr("fill-opacity", point_opacity)
                            .attr("stroke", "none")
                            .attr("d", tweetPath.pointRadius(point_radius))
                    })

                    // label individual tweets
                    .append("title")
                        .text(function(d, i) {
                            var content = tweets.features[i].properties;
                            return content.Place[1] + "\n" 
                                + "Time: " + content.Datetime + " UTC\n"
                                + "User: " + content.User + "\n"
                                + "Text: " + content.Text + "\n";
                        });

                tweetClick(); // default tweet point layer to OFF

            // ------------------------- TRANSLUCENT WINDOW ------------------------- //

                var overlay_frac = 17/20;
                var window_w = 3/20*width,
                    window_c = width-window_w/2;
                svg.append("g")
                    .attr("class", "window")
                    .append("rect")
                        .attr("x", width - window_w)
                        .attr("h", height)
                        .attr("width", window_w)
                        .attr("height", height)
                        .attr("fill", "white")
                        .attr("fill-opacity", 0.8)

            // -------------------------- COLOR SCALE BAR --------------------------- //
                // See https://www.visualcinnamon.com/2016/05/smooth-color-legend-d3-svg-gradient.html

                //Append a definition element to our SVG
                var defs = svg.append("defs");

                // Append linearGradient element to definitions with unique id
                var linGradElement = (id) => {
                    return element = defs.append("linearGradient")
                        .attr("id", id)
                }

                // Vertical gradient attributes
                var vertAttrs = {
                    "x1": "0%",
                    "y1": "100%",
                    "x2": "0%",
                    "y2": "0%",
                }

                // Set multiple attributes at once
                function setAttr(element, attrs) {
                    for (var key in attrs) {
                        element.attr(key, attrs[key])
                    }
                }

                // Set color range
                function setColorRange(element, low_color, high_color) {
                    element.selectAll("stop")
                    .data([
                        {offset:   "0%", color: low_color},
                        {offset: "100%", color: high_color}
                    ])
                    .enter().append("stop")
                    .attr("offset", function(d) {return d.offset;})
                    .attr("stop-color", function(d) {return d.color;})
                }

                // Set color key location and dimensions
                var key_width = window_w/8,
                    rect_height = height/2.4,
                    key_gap = key_width/4,
                    key_xpos = window_c-key_gap/2-key_width, 
                    key_ypos = height/4;

                var color_keys = svg.append("g")
                    .attr("class", "color-keys")

                // Make color key rectangle and fill with gradient
                function mkRectGrad(buttonFunction, id, [xpos, ypos]) {
                    color_keys.append("rect")
                        .attr("id", id)
                        .attr("class", "button")
                        .attr("cursor", "pointer")
                        .on("click", buttonFunction)
                        .attr("x", xpos)
                        .attr("y", ypos)
                        .attr("width", key_width)
                        .attr("height", rect_height)
                        // .attr("stroke", "darkgray")
                        // .attr("stroke-linejoin", "miter")
                        // .attr("stroke-width", 1)
                        .style("fill", "url(#" + id + ")"); 
                }

                tweetGrad = linGradElement("tweet-grad");
                setAttr(tweetGrad, vertAttrs);
                setColorRange(tweetGrad, low_color, high_color);

                popGrad = linGradElement("pop-grad");
                setAttr(popGrad, vertAttrs);
                setColorRange(popGrad, low_pop_color, high_pop_color);

                mkRectGrad(blueClick, "tweet-grad", [key_xpos, key_ypos]);
                mkRectGrad(redClick, "pop-grad", 
                    [key_xpos + key_width + key_gap, key_ypos]);

                function addKeyTitle(title, [x_off, y_off]) {
                    color_keys.append("text")
                        .attr("class","h1")
                        // transform coordinate system
                        .attr("transform", "rotate(90)")   
                        .attr("y", -(key_xpos + x_off))            // -x position
                        .attr("x", key_ypos + rect_height + y_off) //  y position
                        .attr("fill", "black")
                        .attr("font-size", 20)
                        .text(title);
                }

                addKeyTitle("Tweet Density", [3, 4]);
                addKeyTitle("Population Density", [3 + key_width + key_gap, 4]);
            
            // ------------------------ TOGGLE LAYER BUTTON ------------------------- //
                // This is pretty clunky, but it seems to work...
                
                var button = svg.append("g")
                    .attr("class", "buttons");
                                
                function toggleVis(s, button) {
                    if (button === false) {
                        s.attr("visibility", "hidden")
                        return button = true;

                    } else {
                        s.attr("visibility", "visible")
                        return button = false;
                    }
                }

                function click(my_class, my_button) {
                    var s = d3.select("svg").select(".map")
                        .selectAll(my_class);
                    return my_button = toggleVis(s, my_button);
                }

                function shadowClick() {
                    shadow_button = click(".shadow", shadow_button);
                }

                function blueClick() {
                    blue_button = click(".county-tweet-path", blue_button);
                    if (red_button === true) {
                        red_button = click(".county-pop-path", red_button);
                    }
                }

                function redClick() {
                    red_button = click(".county-pop-path", red_button);
                }
                
                function tweetClick() {
                    tweet_button = click(".tweets", tweet_button);
                }

                var rect_height = Math.floor((2*key_width + key_gap)/1.2),
                    rect_width = 2*key_width + key_gap;
                    rad = key_width + key_gap/2;

                grect = button.append("g")
                    grect.append("line")
                        .attr("x1", key_xpos)
                        .attr("x2", key_xpos + rect_width)
                        .attr("y1", key_ypos - 3*key_gap - rect_height/2)
                        .attr("y2", key_ypos - 3*key_gap - rect_height/2)
                        .attr("stroke", "black")
                        .attr("stroke-width", 1)
                    grect.append("rect")
                        .attr("class", "button")
                        .attr("cursor", "pointer")
                        .attr("x", key_xpos)
                        .attr("y", key_ypos - 3*key_gap - rect_height)
                        .attr("height", rect_height)
                        .attr("width", rect_width)
                        .attr("fill", "black")
                        .attr("fill-opacity", shadow_opacity)
                        .on("click", shadowClick);
                    
                button.append("circle")
                    .attr("class", "button")
                    .attr("cursor", "pointer")
                    .attr("cx", window_c)
                    .attr("cy", key_ypos - 6*key_gap - rect_height - rad)
                    .attr("r", rad)
                    .attr("fill", "rgb(0, 172, 237)")
                    .on("click", tweetClick);
                      
            // ----------------------------- EXPORT SVG ----------------------------- //
                
                // ?????

            // ------------------------ ZOOMING CAPABILITIES ------------------------ //
                // See: https://bl.ocks.org/mbostock/3127661b6f13f9316be745e77fdfb084

                svg.call(d3.zoom()
                    .scaleExtent([zoom_low, zoom_high])
                    .on("zoom", zoomed));
                
                function zoomed() {
                  g.attr("transform", d3.event.transform);
                }

            // ----------------------------- SVG BORDER ----------------------------- //

                svg.append("rect")
                    .attr("class", "border")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("height", height)
                    .attr("width", width)
                    .attr("stroke", "black")
                    .attr("stroke-width", 1)
                    .attr("fill", "none");
            
        }

        </script>
    </div>
  </body>
</html>