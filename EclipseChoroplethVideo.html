<!DOCTYPE html>

<!-- ***** See: https://youtu.be/suNs5p0IxWk ***** -->

<html>
  <style>

    * {
        font-family: 
            "Nunito", "Myriad Pro Light", "Oswald", Helvetica, sans-serif;
        margin: 0;
        padding: 0;
    }

    div #header {
        background-color: rgb(210,210,220);
        padding: 1.5% 0;
        /*position: fixed;
        top: 0;
        width: 100%;*/
    }

    div #footer {
        background-color: rgba(210,210,220,0.9);
        padding: 1% 0;
        position: fixed;
        bottom: 0;
        width: 100%;
        padding-left: 1%;

    }

    div #footer a {
        text-decoration: none;
        target: _blank;
    }

    body {
        background-color: black;
    }
    
    .button:hover {
        fill-opacity: 0.4;
    }

    .centered {
        text-align: center;
    }

    h1 {
        font-size: 250%;
        font-weight: normal;
    }

    p {
        position: auto;
        font-size: 120%;
        display: inline;
    }

    svg {
        display: block;
        margin: 0 auto;
        background-color: white;
    }

  </style>
  <head>
    <meta charset = "utf-8" name="viewport" content="width=device-width, initial-scale=1">
    <title>Eclipse Twitter Tracker Choropleth</title>

    <link href="https://fonts.googleapis.com/css?family=Nunito:400,700" rel="stylesheet">
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src ="C:\Users\Christopher\Documents\GitHub\node_modules\save-svg-as-png\saveSvgAsPng.js"></script>

  </head>
  <body>
    <div class="container">
        <!-- Title -->
        <!-- <div id="header">
          <h1 class="title centered">The Great American Eclipse on Twitter: <i>August 21, 2017</i></h1>
        </div> -->
        <div id="image">
            <svg> 
                <filter id="blur">
                  <feGaussianBlur stdDeviation="5"></feGaussianBlur>
                </filter>
            </svg>
        </div>

        <!-- Info -->
        <!-- <div id="footer">
            <p><b>Created by:</b> <a href="https://github.com/chrismbryant" targer="_blank">Christopher M. Bryant</a>, 2017</br></p>
            <p><i>(with data collected from <a href="https://dev.twitter.com/streaming/overview" target="_blank">Twitter's Streaming API</a>, <a href="https://eclipse.gsfc.nasa.gov/SEpath/SEpath2001/SE2017Aug21Tpath.html" target="_blank">NASA</a>, and the <a href="https://www.census.gov/data/developers/data-sets/popest-popproj/popest.html" target="_blank">US Census Bureau</a>)</i></p>
        </div> -->
        <!-- D3 code -->
        <script>

        // var header_h = document.getElementById("header").clientHeight;
        // var footer_h = document.getElementById("footer").clientHeight;
        // var inner_h = window.innerHeight;
        // var image_h = inner_h - header_h;


        var svg = d3.select("svg"),
            
            
            // height = 0.4 * window.screen.availHeight,
            // width = 0.4 * window.screen.availWidth,

            // testwidth = screen.availWidth,
            // testheight = image_h,

            testwidth = 1920,
            testheight = 1080,

            width = 1152,  // 1152
            height = 600,  // 600

            zoom_low = 0.5,   // lowest zoom magnification
            zoom_high = 20; // highest zoom magnification

        var image_title = "eclipse_choropleth";

        svg.attr("class", "mysvg")
            .attr("id", image_title)
            .attr("width", testwidth)
            .attr("height", testheight)
            .attr("fill", "none")
            .attr("stroke", "none")

        // defining variables for color-scaling
        var low_color = "rgb(200, 211, 234)",    // color for lowest tweet fraction
            high_color = "rgb(8,48,107)",      // color for highest tweet fraction
            low_pop_color = "white",           // color for lowest population density
            high_pop_color = "rgb(130,0,0)",   // color for highest population density
            border_color = "rgb(240,240,240)", // color for county borders
            c_num = 2,                         // no. of std devs to span with color
            color_domain = [-c_num, c_num];    // min and max color mapping value
        
        // defining button state variables for layer toggling
        var shadow_button 
            = blue_button
            = red_button
            = tweet_button
            = false;

        var pop_color = d3.scaleLinear()
            .domain(color_domain)
            .range([low_pop_color, high_pop_color]);

        var county_color = d3.scaleLinear()
            .domain(color_domain)
            .range([low_color, high_color]);
        
        // eclipseData
        var eclipseData = d3.map();

        // choose which file to plot by choosing dt and deltaT
        var dt = 0.5,
            deltaT = 60;

        // Loading and callback function structure: See https://github.com/kthotav/D3Visualizations/blob/master/New_York_Income_vs_Poverty/js/ny.js

        // load TopoJSON, GeoJSON, and color data file asynchronously
        d3.queue()
            .defer(d3.json, "https://d3js.org/us-10m.v1.json")
            .defer(d3.json, "https://raw.githubusercontent.com/chrismbryant/eclipse-twitter-tracker/master/Resources/tweetGeoJSON.json")
            .defer(d3.json, "https://raw.githubusercontent.com/chrismbryant/eclipse-twitter-tracker/master/Resources/eclipseGeoJSON.json")
            .defer(d3.json, "https://raw.githubusercontent.com/chrismbryant/twitter-eclipse-tracker/master/Resources/eclipseCenterJSON.json")
            .defer(d3.csv, "https://raw.githubusercontent.com/chrismbryant/twitter-eclipse-tracker/master/Resources/Color/countycolordata" 
                + `_d${dt}_delta${deltaT}.csv`, function(d) {
                var Tally = d.Tally.split('[')[1].split(']')[0].split(',');
                var Value = d.Value.split('[')[1].split(']')[0].split(',');
                for (t = 0; t < Tally.length; t++) {
                    Tally[t] = +Tally[t]
                    Value[t] = +Value[t]
                }
                eclipseData.set(d.CountyCode, 
                    [d.CountyCode, Tally, +d.Population, d.Geoname, Value]); 
            })
            .await(ready);

        // callback function  
        function ready(error, topoData, tweetGeoJSON, eclipseGeoJSON, centerlineJSON) {

            if (error) throw error;

            // Load US county TopoJSON (already encoded with Albers projection)
            var us_counties = topojson.feature(topoData, {
                type: "GeometryCollection",
                geometries: topoData.objects.counties.geometries
            });

            // Load tweet GeoJSON
            var tweets = {
                "type": tweetGeoJSON.type,
                "features": tweetGeoJSON.features
            };

            var eclipse = {
                "type": eclipseGeoJSON.type,
                "features": eclipseGeoJSON.features
            }

            var centerline = {
                "type": centerlineJSON.type,
                "features": centerlineJSON.features
            }

            // Custom translation projection, since our TopoJSON file appears to already encoded with Albers USA projection. Noramlly, we would set our corresponding projection to "null", but since we want to more precisely position the map in svg, we'll need to apply some translations. (See: https://bl.ocks.org/mbostock/5663666)

            function trans(dx, dy) {
              return d3.geoTransform({
                point: function(x, y) {
                  this.stream.point(x + dx, y + dy);
                }
              });
            }

            var x_shift = (testwidth-960)/2,
                y_shift = (testheight-680)/2;

            var geoPath = d3.geoPath()
                .projection(trans(x_shift, y_shift));

            // Use the USA Albers projection to map the GeoJSON tweet data
            var proj = d3.geoAlbersUsa()
                .scale(1280) // [HOW DO WE KNOW WHAT THIS NUMBER IS? I JUST GUESSED.]
                .translate(
                    [width*5/12 + x_shift, // width * 5/12
                    height/2 + y_shift]);  // height/2

            // This projection won't crop off the ends of the path
            var proj_2 = d3.geoAlbers()
                .scale(1280)
                .translate([width*5/12 + x_shift, height/2 + y_shift]);


            var tweetPath = d3.geoPath()
                .projection(proj);

            var eclipsePath = d3.geoPath()
                .projection(proj_2);

            var centerPath = d3.geoPath()
                .projection(proj_2);
            
            var g = svg.append("g") // Group all the map stuff together
                .attr("class", "map")
                .attr("transform", "translate(-360, -180) scale(1.36)")

           

            // ---------------------------- TIME-STEPPER ---------------------------- //


                var block = 0; // initialize block at first time
                var blocks = eclipseData['$01001'][1].length;

                // auto
                var pressPlay = () => {
                    setInterval(stepForward, 40);
                }

                var rewind = () => {
                    setInterval(stepBackward, 40);
                }

                var stepForward = () => {
                    if (block < blocks - 1) {
                        block += 1;
                        svg.select(".map").select(".counties").selectAll("path")
                            .data(us_counties.features)
                            .attr("fill", function(d) {
                                var Value = eclipseData.get(d.id)[4][block];
                                return Value ? county_color(Value) : low_color;
                            });
                        svg.select("#clock")
                            .text(whatTime);

                        // move timeblock rectangle
                        var timeblock_i = dt*block*timeln_len/360 + timeln_i;
                        svg.select("#time_block")
                            .attr("x", timeblock_i)

                        shadowpos = block - 220 + 2*deltaT; // 16:50:00 is 220*30 seconds after 15:00:00
                        shadowlag = shadowpos - 2*deltaT;
                        svg.select(".map").select(".current-center").selectAll(".shadow-now")
                            .attr("fill-opacity", reveal)
                            .attr("stroke-opacity", reveal);
                    }
                }

                var stepBackward = () => {
                    if (block > 0) {
                        block -= 1;
                        svg.select(".map").select(".counties").selectAll("path")
                            .data(us_counties.features)
                            .attr("fill", function(d) {
                                var Value = eclipseData.get(d.id)[4][block];
                                return Value ? county_color(Value) : low_color;
                            });
                        svg.select("#clock")
                            .text(whatTime);

                        // move timeblock rectangle
                        var timeblock_i = dt*block*timeln_len/360 + timeln_i;
                        svg.select("#time_block")
                            .attr("x", timeblock_i)

                        shadowpos = block - 220 + 2*deltaT; // 16:50:00 is 220*30 seconds after 15:00:00
                        svg.select(".map").select(".current-center").selectAll(".shadow-now")
                            .attr("fill-opacity", reveal)
                            .attr("stroke-opacity", reveal);
                    }
                }

                var t0 = new Date('2017-08-21 15:00:00 +0000');
                var whatTime = () => {
                    return t = new Date(t0.getTime() + (block * dt + deltaT) * 60*1000);   
                }

            // ------------------------ TOGGLE LAYER BUTTON ------------------------- //
                // This is pretty clunky, but it seems to work...
                
                var button = svg.append("g")
                    .attr("class", "buttons");
                                
                function toggleVis(s, button) {
                    if (button === false) {
                        s.attr("visibility", "hidden")
                        return button = true;

                    } else {
                        s.attr("visibility", "visible")
                        return button = false;
                    }
                }

                function click(my_class, my_button) {
                    var s = d3.select("svg").select(".map")
                        .selectAll(my_class);
                    return my_button = toggleVis(s, my_button);
                }

                function shadowClick() {
                    shadow_button = click(".shadow", shadow_button);
                }

                function blueClick() {
                    blue_button = click(".county-tweet-path", blue_button);
                    if (red_button === true) {
                        red_button = click(".county-pop-path", red_button);
                    }
                }

                function redClick() {
                    if (blue_button === false) {
                        blue_button = click(".county-tweet-path", blue_button);
                    } else {
                        red_button = click(".county-pop-path", red_button);
                    }
                }
                
                function tweetClick() {
                    tweet_button = click(".tweets", tweet_button);
                }

                // grect = button.append("g")
                //     grect.append("line")
                //         .attr("x1", key_xpos)
                //         .attr("x2", key_xpos + rect_width)
                //         .attr("y1", key_ypos - 3*key_gap - rect_height/2)
                //         .attr("y2", key_ypos - 3*key_gap - rect_height/2)
                //         .attr("stroke", "black")
                //         .attr("stroke-width", 1)
                //     grect.append("rect")
                //         .attr("class", "button")
                //         .attr("cursor", "pointer")
                //         .attr("x", key_xpos)
                //         .attr("y", key_ypos - 3*key_gap - rect_height)
                //         .attr("height", rect_height)
                //         .attr("width", rect_width)
                //         .attr("fill", "black")
                //         .attr("fill-opacity", shadow_opacity)
                //         .on("click", shadowClick);
                    
                // button.append("circle")
                //     .attr("class", "button")
                //     .attr("cursor", "pointer")
                //     .attr("cx", window_c)
                //     .attr("cy", key_ypos - 6*key_gap - rect_height - rad)
                //     .attr("r", rad)
                //     .attr("fill", "rgb(0, 172, 237)")
                //     .on("click", tweetClick);

            // ------------------------ TIME-STEPPING BUTTON ------------------------ //

                // rad = 30

                // // Click to step forward in time
                // button.append("circle")
                //     .attr("class", "button")
                //     .attr("id", "forward")
                //     .attr("cursor", "pointer")
                //     .attr("cx", 175)
                //     .attr("cy", 300)
                //     .attr("r", rad)
                //     .attr("fill", "darkgreen")
                //     .on("click", pressPlay); // pressPlay

                // // Click to step backward in time
                // button.append("circle")
                //     .attr("class", "button")
                //     .attr("id", "backward")
                //     .attr("cursor", "pointer")
                //     .attr("cx", 100)
                //     .attr("cy", 300)
                //     .attr("r", rad)
                //     .attr("fill", "darkred")
                //     .on("click", rewind); // rewind

            // ------------------------------ TIMELINE ------------------------------ //

                var svgtime = svg.append("g")
                    .attr("class", "timeline")

                var timeln_y = testheight - 130,
                    timeln_i = 48,
                    timeln_f = testwidth - timeln_i,
                    endrad = 6,
                    timeln_col = "rgb(0,0,0)",
                    bigtick = 14,
                    smalltick = 8;

                // timeblock rectangle
                var timeln_len = timeln_f - timeln_i,
                    timeblock_h = 18,
                    block_rad = 7,
                    timeblock_i = dt*block*timeln_len/360 + timeln_i,
                    timeblock_f = timeblock_i + deltaT*timeln_len/360;
                svgtime.append("rect")
                    .attr("id", "time_block")
                    .attr("x", timeblock_i)
                    .attr("y", timeln_y - timeblock_h)
                    .attr("width", timeblock_f - timeblock_i)
                    .attr("height", timeblock_h*2)
                    .attr("rx", block_rad)
                    .attr("ry", block_rad)
                    .attr("fill", county_color(-1))
                    .attr("fill-opacity", 1);
                    // .attr("stroke", timeln_col);
                    
                // timeline backbone
                svgtime.append('line')
                    .attr("x1", timeln_i)
                    .attr("x2", timeln_f)
                    .attr("y1", timeln_y)
                    .attr("y2", timeln_y)
                    .attr("stroke", timeln_col)
                    .attr("stroke-width", 2);

                // circle endpoints
                ends = [timeln_i, timeln_f]
                for (var i in ends) {
                    svgtime.append("circle")
                        .attr("cx", ends[i])
                        .attr("cy", timeln_y)
                        .attr("r", endrad)
                        .attr("fill", timeln_col);
                }
                
                // big tickmarks and time labels
                for (i = 1; i < 6; i++) {
                    var x = timeln_i + i*(timeln_f - timeln_i)/6;
                    svgtime.append("line")
                        .attr("x1", x)
                        .attr("x2", x)
                        .attr("y1", timeln_y + bigtick)
                        .attr("y2", timeln_y - bigtick)
                        .attr("stroke", timeln_col)
                        .attr("stroke-width", 2);
                    svgtime.append("text")
                        .attr("class", "h1")
                        .attr("fill", "black")
                        .attr("x", x)
                        .attr("y", timeln_y - bigtick - 8)
                        .attr("text-anchor", "middle")
                        .attr("font-size", 20)
                        .text((8 + i) + ":00:00");
                }

                // small tickmarks
                for (i = 1; i < 24; i++) {
                    if (i % 4 !== 0) {
                        var x = timeln_i + i*(timeln_f - timeln_i)/24;
                        svgtime.append("line")
                            .attr("x1", x)
                            .attr("x2", x)
                            .attr("y1", timeln_y + smalltick)
                            .attr("y2", timeln_y - smalltick)
                            .attr("stroke", timeln_col)
                            .attr("stroke-width", 1);
                    }
                }
              
            // ---------------------------- TIME DISPLAY ---------------------------- //

                svg.append("text")
                    .attr("id", "clock")
                    .attr("class","h1")  
                    .attr("x", testwidth/2) 
                    .attr("y", 120) 
                    .attr("fill", "black")
                    .attr("font-size", 24)
                    .text(whatTime)
                    .attr("text-anchor", "middle");

            // ---------------------------- ECLIPSE PATH ---------------------------- //
                // Data retrieved from: https://eclipse.gsfc.nasa.gov/SEpath/SEpath2001/SE2017Aug21Tpath.html

                // Eclipse path
                var center_opacity = 1,
                    shadow_opacity = 0.2 * center_opacity;

                var gg = g.append("g")
                    gg.attr("class", "eclipse-path")
                    .attr("pointer-events", "none") // Makes the layer intangible

                    .append("g")
                        .attr("class", "center-line")
                        .append("path")
                        .attr("class", "shadow")
                        .datum(eclipse.features[0])
                        .attr("d", eclipsePath)
                        .attr("stroke", "black")
                        .attr("stroke-width", 1)
                        .attr("stroke-opacity", center_opacity); // 0.4

                    gg.append("g")
                        .attr("class", "totality-band")
                        .append("path")
                        .attr("class", "shadow")
                        .datum(eclipse.features[1])
                        .attr("d", eclipsePath)
                        .attr("fill", "black")
                        .attr("fill-opacity", shadow_opacity);

                // shadowClick(); // default eclipse path layer to OFF

            // ------------------------------- NATION ------------------------------- //
                // See: https://bl.ocks.org/mbostock/4136647

                // Add a soft shadow around the nation border
                var gnation = g.append("g");
                
                gnation.attr("class", "nation")
                    .append("path")
                    .attr("class", "nation-shadow")
                    .datum(topojson.mesh(topoData, topoData.objects.nation))
                    .attr("d", geoPath)
                    .attr("fill", "black")
                    .attr("fill-opacity", 0.4)
                    .attr("filter", "url(#blur)");

                gnation.append("path")
                    .attr("class", "nation-background")
                    .datum(topojson.mesh(topoData, topoData.objects.nation))
                    .attr("d", geoPath)
                    .attr("fill", "black");

            // ---------------------- COUNTY POPULATION DENSITY --------------------- //

                // Dictionary and list of county population densities

                var getDensity = () => {
                    var density = {};
                    for (var i in us_counties.features) {
                        var county = eclipseData.get(us_counties.features[i].id)[0],
                            area = geoPath.area(us_counties.features[i]),
                            pop = eclipseData["$" + county][2];
                        density[county] = area/pop;
                    }
                    return density; 
                }

                var dict2val = (dictionary) => {
                    var val_list = [];
                    for (var key in dictionary) {
                        val_list.push(dictionary[key]);
                    }
                    return val_list;
                }
                
                density = getDensity();
                density_list = dict2val(density);            
                
                // Define a bunch of math functions for arrays.

                    var sum = (mylist) => {
                        s = 0;
                        for (var i in mylist) {s += mylist[i]}
                        return s;
                    }

                    var pow = (mylist, exp) => {
                        p = [];
                        for (var i in mylist) {p.push(Math.pow(mylist[i],exp))}
                        return p;
                    }

                    var add = (mylist, addend) => {
                        a = [];
                        for (var i in mylist) {a.push(mylist[i] + addend)}
                        return a;
                    }

                    var prod = (mylist, factor) => {
                        p = [];
                        for (var i in mylist) {p.push(mylist[i] * addend)}
                        return p;
                    }
                    
                    var mean = (mylist) => {
                        return mu = sum(mylist) / mylist.length;
                    }

                    var std = (mylist) => {
                        var s = sum(pow(add(mylist,-mean(mylist)), 2));
                        return sigma = Math.pow(s/mylist.length, 0.5);
                    }

                    var logremove = (mylist) => {
                        l = [];
                        for (var i in mylist) {
                            if (mylist[i]) {
                                l.push(Math.log(mylist[i]));
                            }
                        }
                        return l;
                    }

                // Calculate mean and std of density info for proper color mapping
                density_list = logremove(density_list);
                mu = mean(density_list);
                sigma = std(density_list);

                // Recalculate density with normalized and scaled values
                renormdensity = {}
                for (var key in density) {
                    if (Math.log(density[key]) > -1E9) {
                        renormdensity[key] = -(Math.log(density[key]) - mu) / sigma;
                        // I'm not sure why the color scale was reflected, but I'll just
                        // make the values negative for now to reflect the scale back. 
                    }
                }

                // US counties red population layer
                g.append("g")
                    .attr("class", "county-pop")
                    .selectAll("path")
                    .data(us_counties.features)
                    .enter()
                    .append("path")
                        .attr("class", "county-pop-path")
                        .attr("d", geoPath)
                        .attr("stroke", border_color)
                        .attr("stroke-width", 0.2)
                        .attr("fill", function(d) {
                            var county = eclipseData.get(d.id)[0];
                            return (county ? pop_color(renormdensity[county]) : low_pop_color);
                        });

            // -------------------------- COUNTY TWEET DATA ------------------------- //

                // US counties border and fill (fill is bound to eclipse data)
                var max_fill_opacity = 1;
                g.append("g")
                    .attr("class", "counties")
                    .selectAll("path")                // returns an array of <path>...</path> elements in g
                    .data(us_counties.features)       // assigns keys (bind data to array)
                    .enter()                          // for each row in data...
                    .append("path")                   // create new <path>...</path> elements
                        .attr("class", "county-tweet-path") // assigns class attribute "county-tweet-path" to each <path> element
                        .attr("d", geoPath)           // assigns attribute d to each <path> element
                        .attr("stroke", border_color)
                        .attr("stroke-width", 0.05)
                        .attr("stroke-linejoin", "round")
                        .attr("fill-opacity", max_fill_opacity)
                        // .on("click", clicked)
                        
                        .attr("fill", function(d) {
                            var Value = eclipseData.get(d.id)[4][block];
                            return (Value ? county_color(Value) : low_color);
                        })

                        .on("mouseover", function(d) {
                            d3.select(this).transition()
                                .duration(25)
                                .attr("fill-opacity", 0)
                        })

                        .on("mouseout", function(d){
                            d3.select(this).transition()
                                .ease(d3.easeQuadInOut)
                                .duration(400)
                                .attr("fill-opacity", max_fill_opacity)
                        })

                    // us_counties title (label counties with tweet data)
                    .append("title")
                        .text(function(d) {
                            return d.name = eclipseData.get(d.id)[3] + "\n"
                                + "# of Tweets: " + eclipseData.get(d.id)[1][block] + "\n"
                                + "Population: " + eclipseData.get(d.id)[2];
                        });
                    
            // ------------------------------- STATES ------------------------------- //

                // US states border
                g.append("g")
                    .attr("class", "states")
                    .append("path")
                    .attr("class", "state-path")
                    .datum(topojson.mesh(topoData, topoData.objects.states))
                    .attr("d", geoPath)
                    .attr("stroke", "white")
                    .attr("stroke-width", 1);

            // ------------------------------- TWEETS ------------------------------- //
                
                // Draw a dot at each tweet location

                var point_radius = 1 // 1
                var point_opacity = 0.6 // 0.6

                g.append("g")
                    
                    .attr("class", "tweet-points")
                    .selectAll("tweet-points")
                    .data(tweets.features)
                    .enter()

                    .append("a")
                        .attr("href", function(d, i){
                            var content = tweets.features[i].properties;
                            return "https://twitter.com/search?l=&q=eclipse%2C%20OR%20sun%20from%3A" + 
                                content.User + "%20since%3A2017-08-21%20until%3A2017-08-22&src=typd&lang=en";
                        })
                        .attr("target", "_blank")

                    .append("path")
                    .attr("class", "tweets")
                    .attr("d", tweetPath.pointRadius(point_radius))
                    .attr("fill", "rgb(0, 172, 237)")
                    .attr("fill-opacity", point_opacity)

                    .on("mouseover", function(d) {
                        d3.select(this).transition()
                            .ease(d3.easeQuadInOut)
                            .duration(25)
                            .attr("fill-opacity", 1)
                            .attr("stroke", "white")
                            .attr("stroke-width", 1)
                            .attr("d", tweetPath.pointRadius(3 * point_radius))
                    })

                    .on("mouseout", function(d){
                        d3.select(this).transition()
                            .ease(d3.easeQuadInOut)
                            .duration(100)
                            .attr("fill-opacity", point_opacity)
                            .attr("stroke", "none")
                            .attr("d", tweetPath.pointRadius(point_radius))
                    })

                    // label individual tweets
                    .append("title")
                        .text(function(d, i) {
                            var content = tweets.features[i].properties;
                            return content.Place[1] + "\n" 
                                + "Time: " + content.Datetime + " UTC\n"
                                + "User: " + content.User + "\n"
                                + "Text: " + content.Text + "\n";
                        });

                tweetClick(); // default tweet point layer to OFF

            // ------------------------- ECLIPSE CENTERLINE ------------------------- //
                
                var shadow_rad = 10; // 10 fills the path
                var shadowpos = block - 220 + 2*deltaT;
                var shadowlag = shadowpos - 2*deltaT;
                reveal = function(d, i) {
                    if (i == shadowpos) {
                        return 1
                    } else if (i == shadowlag) {
                        return 0.5
                    } else {
                        return 0
                    }
                }

                g.append("g")
                    .attr("class", "current-center")
                    .selectAll("current-center")
                    .data(centerline.features)
                    .enter()
                    .append("path")
                    .attr("class", "shadow-now")
                    .attr("d", centerPath.pointRadius(shadow_rad))
                    .attr("fill", "black")
                    .attr("stroke", "white")
                    .attr("stroke-width", 2)
                    .attr("fill-opacity", reveal)
                    .attr("stroke-opacity", reveal);

            // ------------------------- TRANSLUCENT WINDOW ------------------------- //

                var window_w = 172, // 3/20*width
                    window_c = testwidth-window_w*3/2;
                // svg.append("g")
                //     .attr("class", "window")
                //     .append("rect")
                //         .attr("x", window_c - window_w/2)
                //         .attr("y", 0)
                //         .attr("width", window_w)
                //         .attr("height", testheight - footer_h)
                //         .attr("fill", "white")
                //         .attr("fill-opacity", 0.8)

            // -------------------------- COLOR SCALE BAR --------------------------- //
                // See https://www.visualcinnamon.com/2016/05/smooth-color-legend-d3-svg-gradient.html

                //Append a definition element to our SVG
                var defs = svg.append("defs");

                // Append linearGradient element to definitions with unique id
                var linGradElement = (id) => {
                    return element = defs.append("linearGradient")
                        .attr("id", id)
                }

                // Vertical gradient attributes
                var vertAttrs = {
                    "x1": "0%",
                    "y1": "100%",
                    "x2": "0%",
                    "y2": "0%",
                }

                // Set multiple attributes at once
                function setAttr(element, attrs) {
                    for (var key in attrs) {
                        element.attr(key, attrs[key])
                    }
                }

                // Set color range
                function setColorRange(element, low_color, mid_color, high_color) {
                    element.selectAll("stop")
                    .data([
                        {offset:   "0%", color: low_color},
                        {offset:  "50%", color: mid_color},
                        {offset: "100%", color: high_color}
                    ])
                    .enter().append("stop")
                    .attr("offset", function(d) {return d.offset;})
                    .attr("stop-color", function(d) {return d.color;})
                }

                // Set color key location and dimensions
                var key_width = 20,
                    rect_height = 550,
                    key_xpos = testwidth - 100
                    key_ypos = 100;

                var color_keys = svg.append("g")
                    .attr("class", "color-keys")

                // Make color key rectangle and fill with gradient
                function mkRectGrad(buttonFunction, id, [xpos, ypos]) {
                    color_keys.append("rect")
                        .attr("id", id)
                        .attr("class", "button")
                        .attr("cursor", "pointer")
                        .on("click", buttonFunction)
                        .attr("x", xpos)
                        .attr("y", ypos)
                        .attr("width", key_width)
                        .attr("height", rect_height)
                        .style("fill", "url(#" + id + ")"); 
                }

                tweetGrad = linGradElement("tweet-grad");
                setAttr(tweetGrad, vertAttrs);
                setColorRange(tweetGrad, county_color(-3), county_color(0), county_color(3));

                mkRectGrad(blueClick, "tweet-grad", [key_xpos, key_ypos]);

                function addKeyTitle(title, [x_off, y_off]) {
                    color_keys.append("text")
                        .attr("class","h1")
                        // transform coordinate system
                        .attr("transform", "rotate(90)")   
                        .attr("y", -(key_xpos + key_width + x_off)) // -x position
                        .attr("x", key_ypos + y_off)                //  y position
                        .attr("fill", "black")
                        .attr("font-size", 20)
                        .text(title);
                }

                addKeyTitle("# of Eclipse Tweets / County Population", [6, 95]);


                // Add scale labels
                var mu = -12.7, // mu and sigma for "_d0.5_delta60"
                    sigma = 1.2,
                    scale_labels = [1E-7, 3E-7, 1E-6, 3E-6, 1E-5, 3E-5, 1E-4]; 

                function ro2c(ro) {
                    return (Math.log(ro) - mu) / sigma;
                }

                function c2ypos(c, y0, h) {
                    return y0 + (3 - c) * h / 6; 
                }

                for (i = 0; i < scale_labels.length; i++) {
                    var y_pos = c2ypos(ro2c(scale_labels[i]), key_ypos, rect_height);
                    color_keys.append("text")
                        .attr("class","h1")
                        .attr("x", key_xpos - key_width)
                        .attr("y", y_pos)
                        .attr("text-anchor", "middle")
                        .attr("fill", "black")
                        .attr("font-size", 14)
                        .text(scale_labels[i].toExponential());

                } 

            // ------------------------------- CAPTION ------------------------------ //
                
                svg.append("text")
                    .attr("class", "h1")
                    .attr("text-anchor", "middle")
                    .attr("x", testwidth/2)
                    .attr("y", 85)
                    .attr("fill", "black")
                    .attr("font-size", 36)
                    .attr("font-weight", "bold")
                    .text("The Great American Eclipse on Twitter");

                rheight = 104
                svg.append("rect")
                    .attr("x", 0)
                    .attr("y", testheight - rheight)
                    .attr("width", testwidth)
                    .attr("height", rheight)
                    .attr("fill", county_color(-2.5))
                    .attr()

                svg.append("text")
                    .attr("id", "created_by")
                    .attr("class", "h1")  
                    .attr("x", 25) 
                    .attr("y", testheight - 58) 
                    .attr("fill", "black")
                    .attr("font-size", 24)
                    .attr("font-weight", "bold")
                    .text("Created by:");

                svg.append("text")
                    .attr("id", "caption1")
                    .attr("class","h1")  
                    .attr("x", 158) 
                    .attr("y", testheight - 58) 
                    .attr("fill", "black")
                    .attr("font-size", 24)
                    .text("Christopher M. Bryant, 2017");

                svg.append("text")
                    .attr("id", "caption2")
                    .attr("class", "h1")
                    .attr("x", 25)
                    .attr("y", testheight - 25)
                    .attr("fill", "black")
                    .attr("font-size", 24)
                    .text("(with data collected from Twitter's Streaming API, NASA, and the US Census Bureau)");

            // ----------------------------- EXPORT SVG ----------------------------- //
                
                for (i = 0; i < 10; i++) {
                    saveSvgAsPng(document.getElementById(image_title), image_title + "_" + block + ".png", {scale: 2});
                    stepForward();
                }
                
            // ------------------------ ZOOMING CAPABILITIES ------------------------ //
                // See: https://bl.ocks.org/mbostock/3127661b6f13f9316be745e77fdfb084

                // svg.call(d3.zoom()
                //     .scaleExtent([zoom_low, zoom_high])
                //     .on("zoom", zoomed));
                
                // function zoomed() {
                //     g.attr("transform", d3.event.transform);
                // }

        }

        </script>
    </div>
  </body>
</html>